072-0503

Supplemental SPI information for the OPC-N3

Issue 1

Contents
1

Introduction and Scope

2

Coding Example/flow chart

3

Firmware commands

4

Conversion of Signal Output from the temperature and humidity signal on the
OPC N3

5

Comment on Checksum

6

OPC-N3 Factory settings

7

Revision Control

1

Introduction and Scope

This document is designed to supply supplementary information for those OPC-N3 users wishing to
write their own programs to drive the OPC unit rather than relying on the supplied software.
This document should be used in conjunction with the OPC-N3 Optical Particle Counter Manual
(072-0502).
A coding example, in the form of a flow chart, is provided, as well as additional information on
timing, full details of all the SPI Commands and configuration information and also a list of OPC-N3
Factory settings.
The command list supplied is for firmware 1.14 - 1.17.

Alphasense Ltd

Page 1 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Issue 1

2

Coding Example/flow chart

1.

Set up SPI interface as follows:
SPI Mode1 (clock idle low, data transmitted on clock leading edge).
Set SPI frequency to between 300 kHz and 750 kHz.
SPI Master system must drive MOSI and SCK and SS communication lines.
Delay between a command byte and any subsequent bytes of an SPI communication should
be > 10 ms (< 100 ms).
Delay between final byte of one SPI communication and first byte (command byte) of the
next SPI communication should be > 10 ms (< 100 ms).
Interval between bytes following the command byte of an SPI communication should be > 10
µs (< 100 µs).
Under certain circumstances the intervals may need to be longer i.e. the interval between
one 'Get Histogram' communication sequence and the next should be between 0.5 s and 20
s and no greater than 60 s. The interval after a 'Switch Peripherals/Fan on' sequence should
be > 600 ms (< 2 s) to allow the firmware time to perform multiple attempts to switch the fan
on.
Normally users should allow a much longer time than this anyway e.g. 5-10 s to allow the fan
to get up to speed. Following power-up, the OPC should be allowed at least
2 s to initialise before beginning SPI communication.
The first histogram data set in a session, or the first histogram obtained after any kind of
error condition has passed, will have been recorded over an unknown sampling period and
should be discarded.
The timings and SPI frequencies specified are guidelines only. Users may experiment with
different timings at their own risk.
The SS connection to the OPC should be driven LOW during any SPI communication with
the OPC.

2.
3.
4.
5.
6.

7.

8.
9.

Notes on OPC-N3 Flow Chart:

The flow chart is an example of switching the OPC fan on and off and reading histogram data. For
clarity laser power is not controlled in this example and may be off when histogram data is read. The
user can add laser power control to their code in a similar way to the fan power control in the
example.
*

0x03 is SPI command byte to control power states of OPC peripherals: fan, laser etc.
0x02 is SPI byte following 0x03 to turn fan OFF.
0x03 is SPI byte following 0x03 to turn fan ON.
0x30 is SPI command byte to request a histogram data set.
0xF3 indicates OPC ready for SPI communication.
0x31 (not shown on flow chart) indicates OPC is busy and not yet ready for SPI
communication.

Alphasense Ltd

Page 2 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Issue 1

Figure 1: Flow chart depicting a typical sequence of commands and delays to run an OPC-N3
histogram sampling session. (Note control of the laser is left off for clarity)
Alphasense Ltd

Page 3 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

3

Supplemental SPI information for the OPC-N3

Issue 1

Firmware commands

OPC-N3 SPI functions (from point of view of SPI Master system) for firmware version 1.14-1.17.
Function

Command
byte

Byte(s) out

Write peripheral
power status

0x03

0x03

Byte(s) in (0xF3 is set as standard
initial return byte value from OPCN3)
0x31

0x03

0xF3

OptionByte

0x03

0x13

0x31

0x13

0xF3

0x13

Fan_ON

0x13

LaserDAC_ON

0x13

FanDACval

0x13

LaserDACval

0x13

LaserSwitch

0x13

Gain and AutoGainToggle setting

0x42

0x31

0x42

0xF3

Channel
Digital pot setting

0x42
Channel

0x05

0x31

0x05

0xF3

Read DAC and power 0x13
status

Set Fan or Laser
digital pot

Set Bin Weighting
Index

0x42

0x05

Alphasense Ltd

Page 4 of 21

Notes

Suggest that 10ms be used as delay
between command byte and
following byte.
OptionByte is an 8bit unsigned
integer variable. Bit 0 indicates the
required power status. The
remaining bits select the target
peripheral as follows: Before the
status bit 0 is applied, if the Option
byte is set to the value 1 and then
shifted left one bit this will select
the 'Fan digital pot shutdown state'
as the target. Similarly, if the
Option byte is first set to the value
2, this will select 'Laser digital pot
shutdown state' as the target.
Setting the option byte to 3 will
select 'Laser power switch state'
and setting to 4 will select
'High/Low gain state'. Only one
peripheral can be set at a time.
Suggest that 10ms be used as delay
between command byte and
following byte.
Fan_ON is an 8bit unsigned integer
variable.
LaserDAC_ON is an 8bit unsigned
integer variable.
FanDACval is an 8bit unsigned
integer variable.
LaserDACval is an 8bit unsigned
integer variable.
LaserSwitch is an 8bit unsigned
integer variable.
AutoGainToggle comprises Gain
and AutoGainToggle settings.
Unsigned 8bit integer.
Suggest that 10ms be used as delay
between command byte and
following byte.
Channel is 0 for Fan, 1 for Laser.
Digital pot setting is unsigned 8bit
integer variable.
Suggest that 10ms be used as delay
between command byte and
following byte.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Read information
string

Supplemental SPI information for the OPC-N3

0x3F

Alphasense Ltd

Issue 1

BinWeightingIndex

0x05

0x3F

0x31

0x3F

0xF3

0x3F

InfoStr ascii char00: "O" (=0x4F)

SerialStr is a string of 60 characters.

0x3F

InfoStr ascii char01: "P" (=0x50)

Value of shaded bytes doesn't
matter.

0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F

InfoStr ascii char02: "C" (=0x43)
InfoStr ascii char03: "-" (=0x2D)
InfoStr ascii char04: "N" (=0x4E)
InfoStr ascii char05: "3" (=0x33)
InfoStr ascii char06: " " (=0x20)
InfoStr ascii char07: "I" (=0x49)
InfoStr ascii char08: "s" (=0x73)
InfoStr ascii char09: "s" (=0x73)
InfoStr ascii char10: "1" (=0x31)
InfoStr ascii char11: "." (=0x2E)
InfoStr ascii char12: "1" (=0x31)
InfoStr ascii char13: " " (=0x20)
InfoStr ascii char14: "F" (=0x46)
InfoStr ascii char15: "i" (=0x69)
InfoStr ascii char16: "r" (=0x72)
InfoStr ascii char17: "m" (=0x6D)
InfoStr ascii char18: "w" (=0x77)
InfoStr ascii char19: "a" (=0x61)
InfoStr ascii char20: "r" (=0x72)
InfoStr ascii char21: "e" (=0x65)
InfoStr ascii char22: "V" (=0x56)
InfoStr ascii char23: "e" (=0x65)
InfoStr ascii char24: "r" (=0x72)
InfoStr ascii char25: "=" (=0x3D)
InfoStr ascii char26: "1" (=0x31)
InfoStr ascii char27: "." (=0x2E)
InfoStr ascii char28: "1" (=0x31)
InfoStr ascii char29: "6" (=0x34)
InfoStr ascii char30: "." (=0x2E)
InfoStr ascii char31: "." (=0x2E)
InfoStr ascii char32: "." (=0x2E)
InfoStr ascii char33: "." (=0x2E)
InfoStr ascii char34: "." (=0x2E)
InfoStr ascii char35: "." (=0x2E)
InfoStr ascii char36: "." (=0x2E)
InfoStr ascii char37: "." (=0x2E)
InfoStr ascii char38: "." (=0x2E)
InfoStr ascii char39: "." (=0x2E)
InfoStr ascii char40: "." (=0x2E)
InfoStr ascii char41: "." (=0x2E)
InfoStr ascii char42: "." (=0x2E)
InfoStr ascii char43: "." (=0x2E)

Page 5 of 21

BinWeightingIndex (0-10) is an 8bit
unsigned integer that represents
the index of the preset bin
weightings to use.
Suggest that 10ms be used as delay
between command byte and
following byte.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Read serial number
string

Supplemental SPI information for the OPC-N3

0x10

Alphasense Ltd

Issue 1

0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F
0x3F

InfoStr ascii char44: "." (=0x2E)
InfoStr ascii char45: "." (=0x2E)
InfoStr ascii char46: "." (=0x2E)
InfoStr ascii char47: "." (=0x2E)
InfoStr ascii char48: "." (=0x2E)
InfoStr ascii char49: "." (=0x2E)
InfoStr ascii char50: "." (=0x2E)
InfoStr ascii char51: "." (=0x2E)
InfoStr ascii char52: "." (=0x2E)
InfoStr ascii char53: "." (=0x2E)
InfoStr ascii char54: "." (=0x2E)
InfoStr ascii char55: "." (=0x2E)
InfoStr ascii char56: "." (=0x2E)
InfoStr ascii char57: "." (=0x2E)
InfoStr ascii char58: "B" (=0x42)
InfoStr ascii char59: "S" (=0x53)

0x10

0x31

0x10

0xF3

0x10

SerialStr ascii char00

SerialStr is a string of 60 characters.

0x10

SerialStr ascii char01

Value of shaded bytes doesn't
matter.

0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10

SerialStr ascii char02
SerialStr ascii char03
SerialStr ascii char04
SerialStr ascii char05
SerialStr ascii char06
SerialStr ascii char07
SerialStr ascii char08
SerialStr ascii char09
SerialStr ascii char10
SerialStr ascii char11
SerialStr ascii char12
SerialStr ascii char13
SerialStr ascii char14
SerialStr ascii char15
SerialStr ascii char16
SerialStr ascii char17
SerialStr ascii char18
SerialStr ascii char19
SerialStr ascii char20
SerialStr ascii char21
SerialStr ascii char22
SerialStr ascii char23
SerialStr ascii char24
SerialStr ascii char25
SerialStr ascii char26
SerialStr ascii char27
SerialStr ascii char28
SerialStr ascii char29
SerialStr ascii char30

Page 6 of 21

Suggest that 10ms be used as delay
between command byte and
following byte.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Write serial number
string

Supplemental SPI information for the OPC-N3

0x11

Alphasense Ltd

0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10
0x10

SerialStr ascii char31
SerialStr ascii char32
SerialStr ascii char33
SerialStr ascii char34
SerialStr ascii char35
SerialStr ascii char36
SerialStr ascii char37
SerialStr ascii char38
SerialStr ascii char39
SerialStr ascii char40
SerialStr ascii char41
SerialStr ascii char42
SerialStr ascii char43
SerialStr ascii char44
SerialStr ascii char45
SerialStr ascii char46
SerialStr ascii char47
SerialStr ascii char48
SerialStr ascii char49
SerialStr ascii char50
SerialStr ascii char51
SerialStr ascii char52
SerialStr ascii char53
SerialStr ascii char54
SerialStr ascii char55
SerialStr ascii char56
SerialStr ascii char57
SerialStr ascii char58
SerialStr ascii char59

0x11

0x31

0x11

0xF3

SerialStr ascii char00

0x11

SerialStr ascii char01
SerialStr ascii char02
SerialStr ascii char03
SerialStr ascii char04
SerialStr ascii char05
SerialStr ascii char06
SerialStr ascii char07
SerialStr ascii char08
SerialStr ascii char09
SerialStr ascii char10
SerialStr ascii char11
SerialStr ascii char12
SerialStr ascii char13
SerialStr ascii char14
SerialStr ascii char15
SerialStr ascii char16

SerialStr ascii char00
SerialStr ascii char01
SerialStr ascii char02
SerialStr ascii char03
SerialStr ascii char04
SerialStr ascii char05
SerialStr ascii char06
SerialStr ascii char07
SerialStr ascii char08
SerialStr ascii char09
SerialStr ascii char10
SerialStr ascii char11
SerialStr ascii char12
SerialStr ascii char13
SerialStr ascii char14
SerialStr ascii char15

Page 7 of 21

Issue 1

Suggest that 10ms be used as delay
between command byte and
following byte.
SerialStr is a string of 60 characters.
This string can only be written
once.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Read Firmware
Version

Supplemental SPI information for the OPC-N3

0x12

Alphasense Ltd

SerialStr ascii char17
SerialStr ascii char18
SerialStr ascii char19
SerialStr ascii char20
SerialStr ascii char21
SerialStr ascii char22
SerialStr ascii char23
SerialStr ascii char24
SerialStr ascii char25
SerialStr ascii char26
SerialStr ascii char27
SerialStr ascii char28
SerialStr ascii char29
SerialStr ascii char30
SerialStr ascii char31
SerialStr ascii char32
SerialStr ascii char33
SerialStr ascii char34
SerialStr ascii char35
SerialStr ascii char36
SerialStr ascii char37
SerialStr ascii char38
SerialStr ascii char39
SerialStr ascii char40
SerialStr ascii char41
SerialStr ascii char42
SerialStr ascii char43
SerialStr ascii char44
SerialStr ascii char45
SerialStr ascii char46
SerialStr ascii char47
SerialStr ascii char48
SerialStr ascii char49
SerialStr ascii char50
SerialStr ascii char51
SerialStr ascii char52
SerialStr ascii char53
SerialStr ascii char54
SerialStr ascii char55
SerialStr ascii char56
SerialStr ascii char57
SerialStr ascii char58
SerialStr ascii char59

SerialStr ascii char16
SerialStr ascii char17
SerialStr ascii char18
SerialStr ascii char19
SerialStr ascii char20
SerialStr ascii char21
SerialStr ascii char22
SerialStr ascii char23
SerialStr ascii char24
SerialStr ascii char25
SerialStr ascii char26
SerialStr ascii char27
SerialStr ascii char28
SerialStr ascii char29
SerialStr ascii char30
SerialStr ascii char31
SerialStr ascii char32
SerialStr ascii char33
SerialStr ascii char34
SerialStr ascii char35
SerialStr ascii char36
SerialStr ascii char37
SerialStr ascii char38
SerialStr ascii char39
SerialStr ascii char40
SerialStr ascii char41
SerialStr ascii char42
SerialStr ascii char43
SerialStr ascii char44
SerialStr ascii char45
SerialStr ascii char46
SerialStr ascii char47
SerialStr ascii char48
SerialStr ascii char49
SerialStr ascii char50
SerialStr ascii char51
SerialStr ascii char52
SerialStr ascii char53
SerialStr ascii char54
SerialStr ascii char55
SerialStr ascii char56
SerialStr ascii char57
SerialStr ascii char58

0x12

0x31

0x12

0xF3

0x12

FirmwareVerMajor

0x12

FirmwareVerMinor

Page 8 of 21

Issue 1

Suggest that 10ms be used as delay
between command byte and
following byte.
FirmwareVerMajor is an 8bit
unsigned integer variable.
FirmwareVerMinor is an 8bit
unsigned integer variable.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503
Read Configuration
Variables

Supplemental SPI information for the OPC-N3
0x3C

Alphasense Ltd

0x3C

0x31

0x3C
0x3C

0xF3
BB0 LSB

0x3C

BB0 MSB

0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C

BB1 LSB
BB1 MSB
BB2 LSB
BB2 MSB
BB3 LSB
BB3 MSB
BB4 LSB
BB4 MSB
BB5 LSB
BB5 MSB
BB6 LSB
BB6 MSB
BB7 LSB
BB7 MSB
BB8 LSB
BB8 MSB
BB9 LSB
BB9 MSB
BB10 LSB
BB10 MSB
BB11 LSB
BB11 MSB
BB12 LSB
BB12 MSB
BB13 LSB
BB13 MSB
BB14 LSB
BB14 MSB
BB15 LSB
BB15 MSB
BB16 LSB
BB16 MSB
BB17 LSB
BB17 MSB
BB18 LSB
BB18 MSB
BB19 LSB
BB19 MSB
BB20 LSB
BB20 MSB
BB21 LSB
BB21 MSB
BB22 LSB
BB22 MSB
BB23 LSB
BB23 MSB
BB24 LSB
BB24 MSB
BBD0 LSB

0x3C
0x3C

BBD0 MSB
BBD1 LSB

Page 9 of 21

Issue 1
Suggest that 10ms be used as delay
between command byte and
following byte.
Bin Boundaries ADC (BB0 – BB24)
are 16bit unsigned integer
variables.
Value of shaded bytes doesn't
matter.

Bin Boundaries diameter(um)
(BBD0 – BBD24) are 16bit unsigned
integer variables representing the
diameter in um x100.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Alphasense Ltd

0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C

BBD1 MSB
BBD2 LSB
BBD2 MSB
BBD3 LSB
BBD3 MSB
BBD4 LSB
BBD4 MSB
BBD5 LSB
BBD5 MSB
BBD6 LSB
BBD6 MSB
BBD7 LSB
BBD7 MSB
BBD8 LSB
BBD8 MSB
BBD9 LSB
BBD9 MSB
BBD10 LSB
BBD10 MSB
BBD11 LSB
BBD11 MSB
BBD12 LSB
BBD12 MSB
BBD13 LSB
BBD13 MSB
BBD14 LSB
BBD14 MSB
BBD15 LSB
BBD15 MSB
BBD16 LSB
BBD16 MSB
BBD17 LSB
BBD17 MSB
BBD18 LSB
BBD18 MSB
BBD19 LSB
BBD19 MSB
BBD20 LSB
BBD20 MSB
BBD21 LSB
BBD21 MSB
BBD22 LSB
BBD22 MSB
BBD23 LSB
BBD23 MSB
BBD24 LSB
BBD24 MSB
BW0 LSB

0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C

BW0 MSB
BW1 LSB
BW1 MSB
BW2 LSB
BW2 MSB
BW3 LSB
BW3 MSB
BW4 LSB
BW4 MSB
BW5 LSB
BW5 MSB
BW6 LSB
BW6 MSB
BW7 LSB

Page 10 of 21

Issue 1

Bin Weightings (BW0 – BW23) are
16bit unsigned integer variables.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Alphasense Ltd

0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C
0x3C

BW7 MSB
BW8 LSB
BW8 MSB
BW9 LSB
BW9 MSB
BW10 LSB
BW10 MSB
BW11 LSB
BW11 MSB
BW12 LSB
BW12 MSB
BW13 LSB
BW13 MSB
BW14 LSB
BW14 MSB
BW15 LSB
BW15 MSB
BW16 LSB
BW16 MSB
BW17 LSB
BW17 MSB
BW18 LSB
BW18 MSB
BW19 LSB
BW19 MSB
BW20 LSB
BW20 MSB
BW21 LSB
BW21 MSB
BW22 LSB
BW22 MSB
BW23 LSB
BW23 MSB
M_A LSB

0x3C
0x3C

M_A MSB
M_B LSB

M_B MSB
0x3C

M_B MSB
M_C LSB

0x3C
0x3C

M_C MSB
MaxTOF LSB

0x3C
0x3C

MaxTOF MSB
AMSamplingIntervalCount LSB

0x3C
0x3C

AMSamplingIntervalCount MSB
AMIdleIntervalCount LSB

0x3C
0x3C

AMIdleIntervalCount MSB
AMMaxDataArraysInFile LSB

0x3C
0x3C

AMMaxDataArraysInFile MSB
AMOnlySavePMData

0x3C

AMFanOnInIdle

Page 11 of 21

Issue 1

M_A (PM diameter A) is a 16bit
unsigned integer variable
representing diameter in um * 100.
M_B (PM diameter B) is a 16bit
unsigned integer variable
representing diameter in um * 100.
M_C (PM diameter C) is a 16bit
unsigned integer variable
representing diameter in um * 100.
MaxTOF (Maximum Time Of Flight)
is a 16bit unsigned integer variable.
AMSamplingIntervalCount is a 16bit
unsigned integer variable.
AMIdleIntervalCount is a 16bit
unsigned integer variable.
AMMaxDataArraysInFile is a 16bit
unsigned integer variable.
AMOnlySavePMData is an 8bit
unsigned integer variable.
AMFanOnInIdle is an 8bit unsigned
integer variable.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Write Configuration
Variables

Supplemental SPI information for the OPC-N3

0x3A

Alphasense Ltd

0x3C

AMLaserOnInIdle

0x3C

TOF to SFR factor

0x3C

PVP

0x3C

BinWeightingIndex

0x3A

0x31

0x3A
BB0 LSB

0xF3
0x3A

BB0 MSB
BB1 LSB
BB1 MSB
BB2 LSB
BB2 MSB
BB3 LSB
BB3 MSB
BB4 LSB
BB4 MSB
BB5 LSB
BB5 MSB
BB6 LSB
BB6 MSB
BB7 LSB
BB7 MSB
BB8 LSB
BB8 MSB
BB9 LSB
BB9 MSB
BB10 LSB
BB10 MSB
BB11 LSB
BB11 MSB
BB12 LSB
BB12 MSB
BB13 LSB
BB13 MSB
BB14 LSB
BB14 MSB
BB15 LSB
BB15 MSB
BB16 LSB
BB16 MSB
BB17 LSB
BB17 MSB
BB18 LSB
BB18 MSB
BB19 LSB
BB19 MSB
BB20 LSB
BB20 MSB
BB21 LSB
BB21 MSB
BB22 LSB
BB22 MSB

BB0 LSB
BB0 MSB
BB1 LSB
BB1 MSB
BB2 LSB
BB2 MSB
BB3 LSB
BB3 MSB
BB4 LSB
BB4 MSB
BB5 LSB
BB5 MSB
BB6 LSB
BB6 MSB
BB7 LSB
BB7 MSB
BB8 LSB
BB8 MSB
BB9 LSB
BB9 MSB
BB10 LSB
BB10 MSB
BB11 LSB
BB11 MSB
BB12 LSB
BB12 MSB
BB13 LSB
BB13 MSB
BB14 LSB
BB14 MSB
BB15 LSB
BB15 MSB
BB16 LSB
BB16 MSB
BB17 MSB
BB17 MSB
BB18 LSB
BB18 MSB
BB19 LSB
BB19MSB
BB20 LSB
BB20 MSB
BB21 LSB
BB21 MSB
BB22 LSB

Page 12 of 21

Issue 1
AMLaserOnInIdle is an 8bit
unsigned integer variable.
Time of Flight to Sample Flow Rate
conversion factor' is an 8bit
unsigned integer variable.
PVP (Particle Validation Period) is
an 8bit unsigned integer variable.
BinWeightingIndex (0-9) is an 8bit
unsigned integer that represents
the index of the preset bin
weightings to use.
Suggest that 10ms be used as delay
between command byte and
following byte.
Bin Boundaries ADC (BB0 – BB16)
are 16bit unsigned integer
variables.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Alphasense Ltd

BB23 LSB
BB23 MSB
BB24 LSB
BB24 MSB
BBD0 LSB

BB22 MSB
BB23 LSB
BB23 MSB
BB24 LSB
BB24 MSB

BBD0 MSB
BBD1 LSB
BBD1 MSB
BBD2 LSB
BBD2 MSB
BBD3 LSB
BBD3 MSB
BBD4 LSB
BBD4 MSB
BBD5 LSB
BBD5 MSB
BBD6 LSB
BBD6 MSB
BBD7 LSB
BBD7 MSB
BBD8 LSB
BBD8 MSB
BBD9 LSB
BBD9 MSB
BBD10 LSB
BBD10 MSB
BBD11 LSB
BBD11 MSB
BBD12 LSB
BBD12 MSB
BBD13 LSB
BBD13 MSB
BBD14 LSB
BBD14 MSB
BBD15 LSB
BBD15 MSB
BBD16 LSB
BBD16 MSB
BBD17 LSB
BBD17 MSB
BBD18 LSB
BBD18 MSB
BBD19 LSB
BBD19 MSB
BBD20 LSB
BBD20 MSB
BBD21 LSB
BBD21 MSB
BBD22 LSB
BBD22 MSB
BBD23 LSB
BBD23 MSB
BBD24 LSB
BBD24 MSB
BW0 LSB

BBD0 LSB
BBD0 MSB
BBD1 LSB
BBD1 MSB
BBD2 LSB
BBD2 MSB
BBD3 LSB
BBD3 MSB
BBD4 LSB
BBD4 MSB
BBD5 LSB
BBD5 MSB
BBD6 LSB
BBD6 MSB
BBD7 LSB
BBD7 MSB
BBD8 LSB
BBD8 MSB
BBD9 LSB
BBD9 MSB
BBD10 LSB
BBD10 MSB
BBD11 LSB
BBD11 MSB
BBD12 LSB
BBD12 MSB
BBD13 LSB
BBD13 MSB
BBD14 LSB
BBD14 MSB
BBD15 LSB
BBD15 MSB
BBD16 LSB
BBD16 MSB
BBD17 LSB
BBD17 MSB
BBD18 LSB
BBD18 MSB
BBD19 LSB
BBD19 MSB
BBD20 LSB
BBD20 MSB
BBD21 LSB
BBD21 MSB
BBD22 LSB
BBD22 MSB
BBD23 LSB
BBD23 MSB
BBD24 LSB
BBD24 MSB

BW0 MSB
BW1 LSB
BW1 MSB
BW2 LSB

BW0 LSB
BW0 MSB
BW1 LSB
BW1 MSB

Page 13 of 21

Issue 1

Bin Boundaries diameter(um)
(BBD0 – BBD24) are 16bit unsigned
integer variables representing the
diameter in um x100.

Bin Weightings (BW0 – BW23) are
16bit unsigned integer variables.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3
BW2 MSB
BW3 LSB
BW3 MSB
BW4 LSB
BW4 MSB
BW5 LSB
BW5 MSB
BW6 LSB
BW6 MSB
BW7 LSB
BW7 MSB
BW8 LSB
BW8 MSB
BW9 LSB
BW9 MSB
BW10 LSB
BW10 MSB
BW11 LSB
BW11 MSB
BW12 LSB
BW12 MSB
BW13 LSB
BW13 MSB
BW14 LSB
BW14 MSB
BW15 LSB
BW15 MSB
BW16 LSB
BW16 MSB
BW17 LSB
BW17 MSB
BW18 LSB
BW18 MSB
BW19 LSB
BW19 MSB
BW20 LSB
BW20 MSB
BW21 LSB
BW21 MSB
BW22 LSB
BW22 MSB
BW23 LSB
BW23 MSB
M_A LSB

BW2 LSB
BW2 MSB
BW3 LSB
BW3 MSB
BW4 LSB
BW4 MSB
BW5 LSB
BW5 MSB
BW6 LSB
BW6 MSB
BW7 LSB
BW7 MSB
BW8 LSB
BW8 MSB
BW9 LSB
BW9 MSB
BW10 LSB
BW10 MSB
BW11 LSB
BW11 MSB
BW12 LSB
BW12 MSB
BW13 LSB
BW13 MSB
BW14 LSB
BW14 MSB
BW15 LSB
BW15 MSB
BW16 LSB
BW16 MSB
BW17 LSB
BW17 MSB
BW18 LSB
BW18 MSB
BW19 LSB
BW19 MSB
BW20 LSB
BW20 MSB
BW21 LSB
BW21 MSB
BW22 LSB
BW22 MSB
BW23 LSB
BW23 MSB

M_A MSB
M_B LSB

M_A LSB
M_A MSB

M_B MSB
M_C LSB

M_B LSB
M_B MSB

M_C MSB
MaxTOF Byte0

M_C LSB
M_C MSB

MaxTOF Byte1
MaxTOF Byte0
AMSamplingIntervalCoun MaxTOF Byte1
t LSB
AMSamplingIntervalCoun AMSamplingIntervalCount LSB
t MSB

Alphasense Ltd

Page 14 of 21

Issue 1

M_A (PM diameter A) is a 16bit
unsigned integer variable
representing diameter in um * 100.
M_B (PM diameter B) is a 16bit
unsigned integer variable
representing diameter in um * 100.
M_C (PM diameter C) is a 16bit
unsigned integer variable
representing diameter in um * 100.
Max Time of Flight' is a 16bit
unsigned integer variable.
AMSamplingIntervalCount is a 16bit
unsigned integer variable.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3
AMIdleIntervalCount LSB AMSamplingIntervalCount MSB

Issue 1
AMIdleIntervalCount is a 16bit
unsigned integer variable.

AMIdleIntervalCount MSB AMIdleIntervalCount LSB

Read histogram data 0x30
(and reset histogram)

Alphasense Ltd

AMMaxDataArraysInFile
LSB
AMMaxDataArraysInFile
MSB
AMOnlySavePMData

AMIdleIntervalCount MSB

AMFanOnInIdle

AMOnlySavePMData

AMLaserOnInIdle

AMFanOnInIdle

TOF to SFR factor

AMLaserOnInIdle

PVP

TOF to SFR factor

0x30

0x31

0x30
0x30

0xF3
Bin0 LSB

0x30

Bin0 MSB

0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30

Bin1 LSB
Bin1 MSB
Bin2 LSB
Bin2 MSB
Bin3 LSB
Bin3 MSB
Bin4 LSB
Bin4 MSB
Bin5 LSB
Bin5 MSB
Bin6 LSB
Bin6 MSB
Bin7 LSB
Bin7 MSB
Bin8 LSB
Bin8 MSB
Bin9 LSB
Bin9 MSB
Bin10 LSB
Bin10 MSB
Bin11 LSB
Bin11 MSB
Bin12 LSB
Bin12 MSB
Bin13 LSB
Bin13 MSB
Bin14 LSB
Bin14 MSB
Bin15 LSB
Bin15 MSB
Bin16 LSB
Bin16 MSB
Bin17 LSB
Bin17 MSB
Bin18 LSB
Bin18 MSB

AMMaxDataArraysInFile is a 16bit
unsigned integer variable.

AMMaxDataArraysInFile LSB
AMMaxDataArraysInFile MSB

Page 15 of 21

AMOnlySavePMData is an 8bit
unsigned integer variable.
AMFanOnInIdle is an 8bit unsigned
integer variable.
AMLaserOnInIdle is an 8bit
unsigned integer variable.
'Time of Flight to Sample Flow Rate
conversion factor' is an 8bit
unsigned integer variable.
PVP (Particle Validation Period) is
an 8bit unsigned integer variable.
Suggest that 10ms be used as delay
between command byte and
following byte.
Bin Counts (Bin0 - Bin23) are 16bit
unsigned integer variables.
Value of shaded bytes doesn't
matter.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Alphasense Ltd

0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30
0x30

Bin19 LSB
Bin19 MSB
Bin20 LSB
Bin20 MSB
Bin21 LSB
Bin21 MSB
Bin22 LSB
Bin22 MSB
Bin23 LSB
Bin23 MSB
Bin1 MToF

0x30

Bin3 MToF

0x30

Bin5 MToF

0x30
0x30

Bin7 MToF
Sampling Period LSB

0x30

Sampling Period MSB

0x30

Sample Flow Rate LSB

0x30
0x30

Sample Flow Rate MSB
Temperature LSB

0x30
0x30

Temperature MSB
Relative humidity LSB

0x30
0x30

Relative humidity MSB
PM_A Byte0

0x30
0x30
0x30
0x30

PM_A Byte1
PM_A Byte2
PM_A Byte3
PM_B Byte0

0x30
0x30
0x30
0x30

PM_B Byte1
PM_B Byte2
PM_B Byte3
PM_C Byte0

0x30
0x30
0x30
0x30

PM_C Byte1
PM_C Byte2
PM_C Byte3
Reject count Glitch LSB

0x30
0x30

Reject count Glitch MSB
Reject count LongTOF LSB

0x30
0x30

Reject count LongTOF MSB
Reject count Ratio LSB

0x30
0x30

Reject count Ratio MSB
Reject count OutOfRange LSB

0x30
0x30

Reject count OutOfRange MSB
Fan rev count LSB

0x30

Fan rev count MSB

Page 16 of 21

Issue 1

MToF' is an 8bit unsigned integer
that represents the average
amount of time that particles sized
in the stated bin took to
cross the OPS's laser beam. Each
value is in 1/3 us. i.e. a value
of 10 would represent 3.33us.
Sampling Period' is a 16bit unsigned
integer and is a
measure of the histogram's actual
sampling period in seconds x100
Sample Flow Rate' is a 16bit
unsigned integer variable that
represents the sample flow rate in
ml/s x100
Temperature is a 16bit unsigned
integer.
Relative humidity is a 16bit
unsigned integer.
PM_A is a float variable occupying
4 bytes. Units are ug/m3.

PM_B is a float variable occupying 4
bytes. Units are ug/m3.

PM_C is a float variable occupying 4
bytes. Units are ug/m3.

Reject count Glitch' is a 16bit
unsigned integer.
Reject count LongTOF' is a 16bit
unsigned integer.
Reject count Ratio' is a 16bit
unsigned integer.
Reject count Ratio' is a 16bit
unsigned integer.
Fan rev count' is a 16bit unsigned
integer.

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Read PM data (and
reset histogram)

Save Configuration
Variables in nonvolatile memory

Supplemental SPI information for the OPC-N3

0x32

0x43

Check Status

0xCF

Reset

0x06

Enter bootloader
mode

0x41

0x30

Laser status LSB

0x30
0x30

Laser status MSB
Checksum LSB

0x30
0x32

Checksum MSB
0x31

0x32
0x32

0xF3
PM_A Byte0

0x32
0x32
0x32
0x32

PM_A Byte1
PM_A Byte2
PM_A Byte3
PM_B Byte0

0x32
0x32
0x32
0x32

PM_B Byte1
PM_B Byte2
PM_B Byte3
PM_C Byte0

0x32
0x32
0x32
0x32

PM_C Byte1
PM_C Byte2
PM_C Byte3
Checksum Byte0

0x32
0x43

Checksum Byte1
0x31

0x43
0x3F

0xF3
0x43

0x3C
0x3F
0x3C
0x43
0xCF
0xCF
0x06
0x06
0x41

0x3F
0x3C
0x3F
0x3C
0x31
0xF3
0x31
0xF3
0x31

0x41

0xF3

Issue 1
Laser status' is a 16bit unsigned
integer.
Checksum is a 16bit unsigned
integer.
Suggest that 10ms be used as delay
between command byte and
following byte.
PM_A is a float variable occupying
4 bytes. Units are ug/m3.

PM_B is a float variable occupying 4
bytes. Units are ug/m3.

PM_C is a float variable occupying 4
bytes. Units are ug/m3.

Checksum is a 16bit unsigned
integer.
Suggest that 10ms be used as delay
between command byte and
following byte.
Initial command byte must be
followed by sequence of bytes
(shown in red).

In response to any initial command byte, the OPC-N3 should return a byte of value 0x31, indicating
it is busy.
Upon receiving a command byte OPC-N3 will stop its activities and prepare data for a response if
required.
During this period, until the response data is ready, if further bytes are sent to the OPC-N3, the
returned byte will continue to be 0x31 (busy). When the OPC-N3 has prepared its response data it
will load the SPI buffer with a byte value 0xF3 to indicate it is ready to transfer data. The command
byte value must remain consistent with the original command byte value sent for the command to be
validated by the OPC-N3. If it is not, the OPC-N3 will load the SPI buffer with 0x31 (busy) value and
return to its normal mode of operation. THE SAMPLING TRIGGER WILL NOT BE ARMED IF THIS
OCCURS. Rearming of the trigger can be achieved by a successful histogram or PM data request.
Alphasense Ltd

Page 17 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Issue 1

To communicate with the OPC-N3, the SPI master should poll the OPC-N3 with the command byte
value, checking the returned byte for the value 0x31 (busy) or 0xF3 (ready). The first returned byte
should always be 0x31 (busy). Subsequent returned bytes will either be 0x31 (busy) or 0xF3 (ready)
depending on the status of the OPC-N3. If another byte value is received by the SPI master at this
stage, an error has occurred and communication should cease for > 2s to allow the OPC-N3 to
realise the error and clear its buffered data. The SPI master should also clear any buffered data.

In general, it is suggested that the command byte polling interval is 10 ms and the delay between
byte transfers following a receipt of byte value 0xF3 (ready) is 10 ms.

Alphasense Ltd

Page 18 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

4

Supplemental SPI information for the OPC-N3

Issue 1

Conversion of Signal Output from the temperature and humidity
signal on the OPC N3

Measurement data is always transferred as 16-bit values (unsigned integer). These values are
already linearized and compensated for temperature and supply voltage effects. Converting those
raw values into a physical scale can be achieved using the following formulas.
Relative humidity conversion formula (result in %RH):

Temperature conversion formula (result in °C & °F):

SRH and ST denote the raw sensor output for humidity and temperature, respectively. The formulas
only work correctly when SRH and ST are used in decimal representation.

5

Comment on Check Sum

A 16-bit CRC checksum is transmitted after each histogram data set, which can be used, if desired,
to verify the data sent. If the OPC is configured to only transmit PM data, a checksum will still
accompany this data.
The CRC calculation is a 16-bit method similar to that used in MODBUS communication. It uses the
generator polynomial value 0xA001 and is initialised to 0xFFFF. Example 'C' programming code
showing how the checksum can be recalculated is shown.
unsigned int CalcCRC(unsigned char data[], unsigned char nbrOfBytes)
{
#define POLYNOMIAL 0xA001 //Generator polynomial for CRC
#define InitCRCval 0xFFFF //Initial CRC value
unsigned char _bit; // bit mask
unsigned int crc = InitCRCval; // initialise calculated checksum
unsigned char byteCtr; // byte counter
// calculates 16-Bit checksum with given polynomial
for(byteCtr = 0; byteCtr < nbrOfBytes; byteCtr++)
{
crc ^= (unsigned int)data[byteCtr];
for(_bit = 0; _bit < 8; _bit++)
{
if (crc & 1) //if bit0 of crc is 1
{
crc >>= 1;
crc ^= POLYNOMIAL;
}
else
crc >>= 1;
Alphasense Ltd
Page 19 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

Supplemental SPI information for the OPC-N3

Issue 1

}
}
return crc;
}

Alphasense Ltd

Page 20 of 21

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

072-0503

6

Supplemental SPI information for the OPC-N3

Issue 1

OPC-N3 Factory settings

The OPC firmware retains the factory settings and calibrations.
These settings should not be modified as this will affect the OPC calibration and its accuracy.
If you wish to modify any of these settings, then contact Alphasense at (+44) 1376 556700.
The following parameters are factory set and stored in the firmware:
Bin boundaries

The upper and lower particle size limits defining each of
the 24 size bins. Note the lower boundary of bin 0 and
the higher of bin 23 are fixed. These are defined in ADV
values and microns.

Bin weightings

Correction for size dependent sampling efficiency and
density.
The OPC-N3 has 9 preset indexes of weightings and
one end user configurable index (index 0). Note these
may be undefined on Beta release samples

Laser digital pot setting

A parameter to determine laser beam power.

Fan digital pot setting

A parameter to set fan power, default 255.

NOTE: Changing the laser power will change calibration and the OPC-N3 will require recalibration.
When the OPC-N3 is not sampling, both the laser and fan are switched automatically to low-power
settings/off.

7
Version
A
B
C
D
1

Revision Control
Comment
First Draft
Second Draft
Third Draft (Fw 1.16)
Fourth Draft (Fw 1.17 and flow chart
correction)
Issue 1 (T and H)

Alphasense Ltd

Page 21 of 21

Release Date
December 2017
February 2018
February 2018
May 2018

Released by
Mark Giles
Mark Giles
Mark Giles
Mark Giles

August 2018

Mark Giles

August 2018

Sensor Technology House, 300 Avenue West, Skyline 120, Great Notley. Essex.CM77 7AA. UK
Tel: +44 (0) 1376 556700 - Fax: +44 (0) 1376 335899
Email: sensors@alphasense.com - Web: www.alphasense.com

